# Модуль массового управления доступом для Bitrix

## Назначение

Административный модуль для быстрого и безопасного изменения прав доступа:
- К инфоблокам (по типам инфоблоков + отдельные инфоблоки)
- К структуре сайта (папки/файлы)

## Возможности

### Работа с инфоблоками
- Дерево типов инфоблоков и инфоблоков с чекбоксами
- Массовый выбор по типу инфоблока
- Поиск по названию

### Работа с файлами и папками
- Lazy-load дерево файловой структуры
- Визуальная индикация объектов с нестандартными правами
- Наследование прав для папок

### Общие функции
- **Предпросмотр изменений** — таблица "Было → Станет" перед применением
- **Сброс к дефолту** — установка стандартных прав (Все=чтение, Админы=полный)
- **Удаление субъекта** — массовое удаление группы/пользователя из прав
- **Журнал операций** — полный аудит всех изменений
- **Откат изменений** — снапшоты позволяют отменить пакет изменений

## Установка

1. Скопируйте папку `local.accessmanager` в `/local/modules/`:

```bash
cp -r local.accessmanager /var/www/html/local/modules/
```

2. Перейдите в административную панель Bitrix:
   - **Настройки → Настройки продукта → Модули**

3. Найдите модуль **"Массовое управление доступом"** и нажмите **"Установить"**

4. После установки модуль доступен по пути:
   - **Настройки → Управление доступом (массово)**

## Структура модуля

```
local.accessmanager/
├── install/
│   ├── index.php          # Установщик модуля
│   ├── version.php        # Версия модуля
│   └── admin/
│       └── local_accessmanager.php  # Копируется в /bitrix/admin/
├── admin/
│   ├── accessmanager_main.php   # Главная страница (UI + JS)
│   └── accessmanager_ajax.php   # AJAX обработчики
├── lib/
│   ├── IblockPermissions.php    # Работа с правами инфоблоков
│   ├── FilePermissions.php      # Работа с правами файлов
│   └── Logger.php               # Логирование и снапшоты
├── lang/
│   └── ru/
│       ├── install/index.php    # Языковые константы установщика
│       └── admin/local_accessmanager.php  # Языковые константы UI
├── include.php            # Автозагрузка классов
├── options.php            # Регистрация в меню админки
└── README.md
```

## База данных

Модуль создаёт 2 таблицы:

### `local_accessmanager_log`
Журнал всех операций с правами:
- Кто изменил
- Когда
- Какой объект
- Какие права были → стали

### `local_accessmanager_snapshots`
Снапшоты для отката:
- Batch ID пакета операций
- Состояние прав ДО изменения
- Статус отката

## Уровни прав

### Инфоблоки
- `D` — Доступ закрыт
- `R` — Чтение
- `U` — Редактирование своих элементов
- `S` — Редактирование элементов в своих разделах  
- `W` — Редактирование всех элементов
- `X` — Полный доступ

### Файлы и папки
- `D` — Доступ закрыт
- `R` — Чтение
- `W` — Запись (создание файлов)
- `X` — Полный доступ

## Безопасность

- Доступ только для администраторов
- Проверка `check_bitrix_sessid()` на всех AJAX-запросах
- Валидация путей (защита от `../`)
- Нормализация путей
- Логирование всех операций

## Дефолтные права (при сбросе)

| Группа | Право |
|--------|-------|
| Администраторы [1] | Полный доступ (X) |
| Все пользователи [2] | Чтение (R) |

## Требования

- Bitrix >= 20.0.0
- PHP >= 7.4
- MySQL с поддержкой InnoDB

## Удаление

При удалении модуля таблицы с логами и снапшотами **сохраняются** для аудита.
Для полного удаления раскомментируйте строки в методе `UnInstallDB()` в `install/index.php`.

## Лицензия

Свободное использование.
